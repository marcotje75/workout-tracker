<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Workout Tracker v1.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: white;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
            overflow-x: hidden;
        }

        /* Premium background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.02) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.01) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 20px 16px;
            position: relative;
        }

        .header {
            text-align: center;
            padding: 24px 20px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffb700 100%);
            color: #000;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 
                0 8px 32px rgba(255, 215, 0, 0.25),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 20px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            letter-spacing: -0.5px;
        }

        .date {
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.8;
        }

        .auth-container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 24px;
            border-radius: 16px;
            color: black;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.05);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                0 0 0 3px rgba(255, 215, 0, 0.1);
            transform: translateY(-1px);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffb700 100%);
            border: none;
            border-radius: 16px;
            color: #000;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 16px rgba(255, 215, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button:active {
            transform: scale(0.97);
            box-shadow: 
                0 2px 8px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .connection-status {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        #error-message {
            color: #ff3b30;
            margin-top: 12px;
            text-align: center;
            font-size: 14px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 8% auto;
            padding: 28px;
            border-radius: 24px;
            width: 90%;
            max-width: 430px;
            color: #1a1a1a;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .settings-section h3 {
            font-size: 18px;
            margin-bottom: 16px;
        }

        .danger-zone {
            background-color: #fff8f8;
            border: 1.5px solid #ffcdd2;
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .danger-zone button {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }

        .version-info {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 24px;
        }

        /* iOS-specific adjustments */
        @supports (-webkit-touch-callout: none) {
            input {
                font-size: 16px;
                padding: 12px;
            }
            
            button {
                padding: 14px;
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* New styles for category grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .category-btn {
            background: linear-gradient(135deg, #1a1a1a, #333);
            color: #ffd700;
            padding: 20px 10px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            border: 2px solid #ffd700;
            transition: transform 0.2s;
        }

        .category-btn.active {
            background: linear-gradient(135deg, #ffd700, #ffb700);
            color: black;
        }

        .category-btn:active {
            transform: scale(0.98);
        }

        /* Add to your existing styles */
        .category-edit-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .category-edit-item input {
            flex: 1;
            padding: 8px;
        }

        .save-category-btn {
            padding: 8px 16px !important;
            margin-top: 0 !important;
            width: auto !important;
        }

        .exercise-container {
            margin-top: 24px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            display: none;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .exercise-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
        }

        .exercise-container.active {
            display: block;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .add-exercise-btn {
            background: linear-gradient(135deg, #ffd700, #ffb700) !important;
            margin-top: 15px !important;
        }

        .exercise-item:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            transform: translateX(2px);
            transition: all 0.2s ease;
        }

        .exercise-item button:hover {
            opacity: 0.8;
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        .exercise-name {
            font-weight: 600;
            font-size: 16px;
            color: #1a1a1a;  /* Changed from #ffd700 to dark */
        }

        .exercise-select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .exercise-select:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        .exercise-select option {
            color: #333;
            background: white;
            padding: 10px;
        }

        .exercise-management {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .exercise-management button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            margin: 0 !important;
            margin-top: 0 !important;
            height: 44px;
            min-height: 44px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selected-exercise-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .selected-exercise-display.active {
            display: block;
        }

        .selected-exercise-name {
            font-weight: 600;
            font-size: 18px;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .exercise-stats {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.4;
            text-align: left !important;
        }

        .exercise-stats .stat-row {
            margin-bottom: 6px;
            text-align: left !important;
            display: block !important;
            width: 100%;
        }

        .exercise-stats .stat-row:last-child {
            margin-bottom: 0;
        }

        .exercise-stats .stat-label {
            color: #ccc;
        }

        .exercise-stats .stat-value {
            color: #ffd700;
            font-weight: 500;
        }

        .exercise-notes {
            margin-bottom: 15px;
        }

        .exercise-notes label {
            display: block;
            color: #ffd700;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .exercise-notes textarea {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            color: #333;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 40px;
            max-height: 80px;
        }

        .exercise-notes textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
        }

        .autofill-button {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
            color: white !important;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .autofill-button:hover {
            opacity: 0.9;
        }

        .autofill-button:disabled {
            background: #666 !important;
            cursor: not-allowed;
        }

        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: linear-gradient(135deg, #ff4757, #ff3742) !important;
            color: white !important;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 !important;
            padding: 0 !important;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background: linear-gradient(135deg, #ff3742, #ff2f3a) !important;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(255, 71, 87, 0.4);
        }

        .modal-close-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(255,255,255,0.2), transparent);
            pointer-events: none;
        }

        .modal-content {
            position: relative;
        }

        .set-container {
            margin-left: 25px;
            margin-top: 15px;  /* Increased top margin */
            margin-bottom: 10px;  /* Added bottom margin */
            display: none;
        }

        .set-row {
            display: flex;
            gap: 15px;  /* Increased gap between inputs */
            margin-bottom: 12px;  /* Increased margin between rows */
        }

        .set-input {
            flex: 1;
            padding: 12px !important;  /* Increased padding */
            font-size: 16px !important;  /* Increased font size */
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #333 !important;
            height: 45px !important;  /* Added explicit height */
            border-radius: 8px !important;  /* Added rounded corners */
        }

        .set-input::placeholder {
            color: #666;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #1a1a1a;  /* Changed from #ffd700 to dark */
            cursor: pointer;
            padding: 5px;
            margin: 0;
            font-size: 16px;
            width: 24px !important;
        }

        .save-workout-btn {
            width: 100%;
            padding: 8px !important;
            font-size: 14px !important;
            margin: 20px 0 15px 0 !important;
            background: linear-gradient(135deg, #4CAF50, #45a049) !important;
            color: white !important;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            font-weight: 500;
        }

        .save-workout-btn:hover {
            opacity: 0.9;
        }

        .save-workout-btn:active {
            transform: scale(0.98);
        }

        .body-weight-container input[type="number"] {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #333;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
        }

        .history-buttons button {
            padding: 16px !important;
            font-size: 16px !important;
            color: white !important;
        }

        .history-buttons button:hover {
            opacity: 0.9;
        }

        .period-btn {
            background: linear-gradient(135deg, #ffd700, #ffb700) !important;
            color: #1a1a1a !important;
            border: 2px solid #ffd700 !important;
            font-weight: 600;
            transition: background 0.2s, color 0.2s;
            min-height: 40px;
            font-size: 14px;
            text-align: center;
        }

        .period-btn.active {
            background: #1a1a1a !important;
            color: #ffd700 !important;
            border: 2px solid #ffd700 !important;
        }

        .category-filter-btn {
            padding: 8px 4px !important;
            font-size: 12px !important;
            background: linear-gradient(135deg, #666, #555) !important;
            color: white !important;
            border: 1px solid #777 !important;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-filter-btn.active {
            background: linear-gradient(135deg, #ffd700, #ffb700) !important;
            color: #1a1a1a !important;
            border: 1px solid #ffd700 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gym Workout Tracker <span style="font-size: 0.6em; opacity: 0.7; font-weight: 500;">v1.0</span></h1>
            <div class="date" id="current-date"></div>
        </div>

        <div class="auth-container" id="auth-forms">
            <div id="login-form">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button onclick="login()">Login</button>
                <button onclick="showRegisterForm()">Switch to Register</button>
            </div>

            <div id="register-form" style="display: none;">
                <h2>Register</h2>
                <div class="form-group">
                    <label for="register-name">Name</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" required>
                </div>
                <button onclick="register()">Register</button>
                <button onclick="showLoginForm()">Switch to Login</button>
            </div>

            <div id="error-message"></div>
        </div>
    </div>

    <div class="connection-status" id="connection-status"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAMOV6YxILHYVhNXaBS-_ibqfNsIwS8N4k",
            authDomain: "YOgym-workout-tracker-1b2d7.firebaseapp.com",
            projectId: "gym-workout-tracker-1b2d7",
            storageBucket: "gym-workout-tracker-1b2d7.appspot.com",
            messagingSenderId: "953851185030",
            appId: "1:953851185030:web:0ab402f999fecb9c268e07"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }

        // Add after Firebase initialization and before other code
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Add these global variables
        let currentWorkouts = [];
        let currentCategoryFilter = 'all';
        
        // Initialize exercise cache and counter when page loads
        setTimeout(() => {
            // Wait for authentication state before loading data
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log("User authenticated, loading exercise cache...");
                    // Load all exercises to populate the individual categories cache
                    db.collection('exercises').get().then(querySnapshot => {
                        console.log("Loading exercise categories cache...");
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.individualCategory) {
                                exerciseIndividualCategories[doc.id] = data.individualCategory;
                                console.log("Cached exercise:", doc.id, "->", data.individualCategory);
                            }
                        });
                        console.log("Exercise categories cache loaded:", exerciseIndividualCategories);
                        
                        // Now update the counter
                        updateDailyExerciseCounter();
                    }).catch(error => {
                        console.error("Error loading exercise cache:", error);
                        // Still try to update counter even if cache fails
                        updateDailyExerciseCounter();
                    });
                } else {
                    console.log("User not authenticated, showing 0 exercises");
                    // User not logged in, show 0 exercises
                    updateCounterDisplay({}, 0);
                }
            });
        }, 1000); // Small delay to ensure Firebase is ready

        // Verify Firestore connection
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code == 'unimplemented') {
                    console.warn('The current browser does not support persistence.');
                }
            });

        // Update date
        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        }
        updateDate();

        // Authentication functions
        function showRegisterForm() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }

        function showLoginForm() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }

        function register() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    return userCredential.user.updateProfile({
                        displayName: name
                    });
                })
                .then(() => {
                    showLoginForm();
                    document.getElementById('error-message').textContent = 'Registration successful! Please login.';
                })
                .catch((error) => {
                    document.getElementById('error-message').textContent = error.message;
                });
        }

        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    document.getElementById('error-message').textContent = error.message;
                });
        }

        let exerciseData = {};  // This will store our temporary data

        // Add this function to save temporary data
        function saveTemporaryData(inputId, value) {
            exerciseData[inputId] = value;
            // Save to localStorage as backup
            localStorage.setItem('exerciseData', JSON.stringify(exerciseData));
            // Update the daily exercise counter
            console.log('saveTemporaryData called:', inputId, value);
            updateDailyExerciseCounter();
        }

        // Add this function to restore data when page loads
        function loadSavedData() {
            const savedData = localStorage.getItem('exerciseData');
            if (savedData) {
                exerciseData = JSON.parse(savedData);
                // Update counter after a short delay to ensure DOM is ready
                setTimeout(() => {
                    updateDailyExerciseCounter();
                }, 100);
            }
        }

        // Add this function to clear data on logout
        function clearExerciseData() {
            exerciseData = {};
            localStorage.removeItem('exerciseData');
        }

        // Update the logout function
        function logout() {
            clearExerciseData();  // Clear exercise data
            firebase.auth().signOut()
                .then(() => {
                    console.log('Logged out successfully');
                    document.getElementById('error-message').textContent = '';
                    const loginTemplate = document.getElementById('login-template');
                    document.getElementById('auth-forms').innerHTML = loginTemplate.innerHTML;
                })
                .catch((error) => {
                    console.error('Logout error:', error);
                    document.getElementById('error-message').textContent = error.message;
                });
        }

        // Initialize categories in Firebase
        const defaultCategories = [
            { id: 'cat1', name: 'Biceps, Shoulder & Back' },
            { id: 'cat2', name: 'Chest & Triceps' },
            { id: 'cat3', name: 'Legs' },
            { id: 'cat4', name: 'Abs & Core' }
        ];

        // Individual muscle categories for exercise classification
        const individualCategories = [
            { id: 'chest', name: 'Chest' },
            { id: 'triceps', name: 'Triceps' },
            { id: 'back', name: 'Back' },
            { id: 'shoulders', name: 'Shoulders' },
            { id: 'biceps', name: 'Biceps' },
            { id: 'abs', name: 'Abs' },
            { id: 'legs', name: 'Legs' }
        ];

        // Cache for exercise individual categories
        const exerciseIndividualCategories = {};

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            const authForms = document.getElementById('auth-forms');
            const connectionStatus = document.getElementById('connection-status');

            if (user) {
                const lastLogin = user.metadata.lastSignInTime;
                const formattedLastLogin = new Date(lastLogin).toLocaleString();
                
                // Replace the logged-in content section in auth.onAuthStateChanged
                authForms.innerHTML = `
                    <div class="logged-in-content">
                        <h2 style="font-size: 1.5em; margin-bottom: 5px;">Welcome back!</h2>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                            ${user.displayName || 'User'}<br>
                            Last login: ${formattedLastLogin}
                        </p>
                        <button onclick="logout()" id="logout-btn">Logout</button>
                        
                        <div class="category-grid">
                            ${defaultCategories.map((cat, idx) => `
                                <button 
                                    class="category-btn${idx === 0 ? ' active' : ''}" 
                                    data-id="${cat.id}" 
                                    onclick="selectCategory('${cat.id}')"
                                >${cat.name}</button>
                            `).join('')}
                        </div>

                        <div id="daily-exercise-counter" style="
                            margin: 20px 0;
                            padding: 16px 20px;
                            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.05) 100%);
                            backdrop-filter: blur(20px);
                            border: 1px solid rgba(255, 215, 0, 0.2);
                            border-radius: 16px;
                            text-align: center;
                            font-size: 15px;
                            color: #ffd700;
                            font-weight: 600;
                            box-shadow: 
                                0 4px 16px rgba(255, 215, 0, 0.1),
                                inset 0 1px 0 rgba(255, 255, 255, 0.1);
                            position: relative;
                            overflow: hidden;
                        ">
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                height: 1px;
                                background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.5), transparent);
                            "></div>
                            <div id="counter-content" style="position: relative; z-index: 1;">Today: 0 exercises</div>
                        </div>

                        <div id="exercise-area">
                            ${defaultCategories.map((cat, idx) => `
                                <div id="exercise-container-${cat.id}" 
                                     class="exercise-container${idx === 0 ? ' active' : ''}">
                                    
                                    <select id="exercise-select-${cat.id}" class="exercise-select" onchange="selectExercise('${cat.id}', this.value)">
                                        <option value="">Select an exercise...</option>
                                    </select>
                                    
                                    <div class="exercise-management">
                                        <button onclick="addExercise('${cat.id}')" class="add-exercise-btn">+ Add New</button>
                                        <button onclick="editExercise('${cat.id}')" class="edit-exercise-btn" style="background: linear-gradient(135deg, #ff9800, #f57c00) !important;">‚úèÔ∏è Edit</button>
                                        <button onclick="deleteSelectedExercise('${cat.id}')" class="delete-exercise-btn" style="background: linear-gradient(135deg, #f44336, #d32f2f) !important;">üóëÔ∏è Delete</button>
                                    </div>
                                    
                                    <div id="selected-exercise-${cat.id}" class="selected-exercise-display">
                                        <div id="selected-exercise-name-${cat.id}" class="selected-exercise-name"></div>
                                        <div id="selected-exercise-sets-${cat.id}"></div>
                                    </div>
                                    
                                    <div id="exercises-${cat.id}" style="display: none;">
                                        <!-- Hidden container for exercise data management -->
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <button 
                            onclick="saveWorkout()" 
                            class="save-workout-btn"
                            style="margin-top: 20px; background: linear-gradient(135deg, #4CAF50, #45a049) !important;"
                        >üíæ Save Workout</button>

                        <div class="history-buttons" style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                            margin-bottom: 20px;
                        ">
                            <button 
                                onclick="viewHistory()" 
                                style="
                                    background: linear-gradient(135deg, #2196F3, #1976D2) !important;
                                    padding: 8px;
                                    font-size: 14px;
                                    border-radius: 6px;
                                    border: none;
                                    color: white;
                                    cursor: pointer;
                                    font-weight: 500;
                                "
                            >üìã View History</button>
                            <button 
                                onclick="viewProgress()" 
                                style="
                                    background: linear-gradient(135deg, #1565C0, #0D47A1) !important;
                                    padding: 8px;
                                    font-size: 14px;
                                    border-radius: 6px;
                                    border: none;
                                    color: white;
                                    cursor: pointer;
                                    font-weight: 500;
                                "
                            >üìà View Progress</button>
                        </div>

                        <!-- Add this new element -->
                        <div class="body-weight-container" style="margin: 20px 0;">
                            <button 
                                onclick="showBodyWeightModal()" 
                                class="body-weight-btn"
                                style="
                                    width: 100%;
                                    padding: 16px;
                                    background: linear-gradient(135deg, #ffd700, #ffb700) !important;
                                    border-radius: 12px;
                                    font-size: 16px;
                                    color: #1a1a1a;
                                    font-weight: 600;
                                "
                            >‚öñÔ∏è Body Weight</button>
                        </div>

                        <button onclick="showSettings()" class="settings-btn">‚öôÔ∏è Settings</button>
                    </div>
                `;
                connectionStatus.textContent = 'üü¢ Connected';
                connectionStatus.style.backgroundColor = '#4CAF50';

                // Initialize categories in Firebase if they don't exist
                initializeCategories();

                // Select first category by default
                window.selectedCategoryId = defaultCategories[0].id;
                setTimeout(() => selectCategory(defaultCategories[0].id), 0);
            } else {
                authForms.innerHTML = document.getElementById('login-template').innerHTML;
                connectionStatus.textContent = 'üî¥ Not Connected';
                connectionStatus.style.backgroundColor = '#f44336';
            }
        });

        async function initializeCategories() {
            const categoriesRef = db.collection('categories');
            const snapshot = await categoriesRef.get();

            if (snapshot.empty) {
                // Initialize default categories
                defaultCategories.forEach(async (cat) => {
                    await categoriesRef.doc(cat.id).set({
                        name: cat.name,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
            }
        }

        function selectCategory(categoryId) {
            // Remove active class from all buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Hide all exercise containers
            document.querySelectorAll('.exercise-container').forEach(container => {
                container.classList.remove('active');
            });

            // Add active class to selected button
            const selectedBtn = document.querySelector(`[data-id="${categoryId}"]`);
            selectedBtn.classList.add('active');

            // Show selected exercise container
            const selectedContainer = document.getElementById(`exercise-container-${categoryId}`);
            selectedContainer.classList.add('active');

            // Store selected category in state
            window.selectedCategoryId = categoryId;

            // Load exercises for the selected category
            loadExercises(categoryId);
        }

        async function showSettings() {
            document.getElementById('settings-modal').style.display = 'block';
            await loadCategoryEditor();
        }

        async function loadCategoryEditor() {
            const categoryList = document.getElementById('category-edit-list');
            const categoriesRef = db.collection('categories');
            const snapshot = await categoriesRef.get();
            
            let html = '';
            snapshot.forEach(doc => {
                const category = doc.data();
                html += `
                    <div class="category-edit-item">
                        <input 
                            type="text" 
                            id="cat-${doc.id}" 
                            value="${category.name}"
                            placeholder="Category name"
                        >
                        <button 
                            class="save-category-btn"
                            onclick="updateCategoryName('${doc.id}')"
                        >
                            Save
                        </button>
                    </div>
                `;
            });
            
            categoryList.innerHTML = html;
        }

        async function updateCategoryName(categoryId) {
            const input = document.getElementById(`cat-${categoryId}`);
            const newName = input.value.trim();
            
            if (!newName) {
                alert('Category name cannot be empty');
                return;
            }
            
            try {
                await db.collection('categories').doc(categoryId).update({
                    name: newName,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update category button text in main view
                const categoryBtn = document.querySelector(`[data-id="${categoryId}"]`);
                if (categoryBtn) {
                    categoryBtn.textContent = newName;
                }
                
                alert('Category name updated successfully!');
            } catch (error) {
                console.error('Error updating category:', error);
                alert('Error updating category name');
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        async function changeName() {
            const newName = document.getElementById('change-name').value.trim();
            if (!newName) {
                alert('Please enter a valid name');
                return;
            }

            try {
                const user = firebase.auth().currentUser;
                await user.updateProfile({
                    displayName: newName
                });
                alert('Name updated successfully!');
                closeSettings();
                // Refresh the welcome message
                auth.onAuthStateChanged(auth.currentUser);
            } catch (error) {
                alert('Error updating name: ' + error.message);
            }
        }

        function exportData() {
            // Placeholder for export functionality
            alert('Export functionality coming soon!');
        }

        function importData() {
            // Placeholder for import functionality
            alert('Import functionality coming soon!');
        }

        function resetExercises() {
            if (confirm('Are you sure you want to reset all exercise data? This cannot be undone!')) {
                const user = firebase.auth().currentUser;
                if (!user) {
                    alert('Please log in to reset exercise data.');
                    return;
                }
                // Remove all exercise input data for this user (not names)
                const promises = [];

                // Delete from exerciseInputs
                promises.push(
                    db.collection('exerciseInputs').where('userId', '==', user.uid).get()
                        .then(snapshot => {
                            const batch = db.batch();
                            snapshot.forEach(doc => batch.delete(doc.ref));
                            return batch.commit();
                        })
                );

                // Delete from workouts
                promises.push(
                    db.collection('workouts').where('userId', '==', user.uid).get()
                        .then(snapshot => {
                            const batch = db.batch();
                            snapshot.forEach(doc => batch.delete(doc.ref));
                            return batch.commit();
                        })
                );

                Promise.all(promises)
                    .then(() => {
                        alert('All exercise input and workout data has been reset.');
                    })
                    .catch(error => {
                        alert('Error resetting exercise data: ' + error.message);
                    });
            }
        }

        function resetWeights() {
            if (confirm('Are you sure you want to reset all weight data? This cannot be undone!')) {
                const user = firebase.auth().currentUser;
                if (!user) {
                    alert('Please log in to reset weight data.');
                    return;
                }
                // Remove all weight input data for this user
                db.collection('bodyweights').where('userId', '==', user.uid).get()
                    .then(snapshot => {
                        const batch = db.batch();
                        snapshot.forEach(doc => batch.delete(doc.ref));
                        return batch.commit();
                    })
                    .then(() => {
                        alert('All weight input data has been reset.');
                    })
                    .catch(error => {
                        alert('Error resetting weight data: ' + error.message);
                    });
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modalMap = {
                'settings-modal': closeSettings,
                'body-weight-modal': closeBodyWeightModal,
                'weight-history-modal': closeWeightHistory,
                'weight-progress-modal': closeWeightProgress
            };

            const modal = event.target;
            if (modal.classList.contains('modal')) {
                const closeFunction = modalMap[modal.id];
                if (closeFunction) {
                    closeFunction();
                }
            }
        }
        // Templates
        const loginTemplate = `
            <div id="login-form">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button onclick="login()">Login</button>
                <button onclick="showRegisterForm()">Switch to Register</button>
            </div>
        `;

        document.getElementById('login-template').innerHTML = loginTemplate;

        // Add this function as a placeholder for add exercise
        // Exercise Modal Functions
        let currentCategoryId = null;
        let currentExerciseId = null;
        let isEditMode = false;

        function openExerciseModal(categoryId, exerciseId = null) {
            console.log('openExerciseModal called with:', categoryId, exerciseId);
            
            currentCategoryId = categoryId;
            currentExerciseId = exerciseId;
            isEditMode = !!exerciseId;
            
            const modal = document.getElementById('exercise-modal');
            console.log('Modal element found:', modal);
            
            if (!modal) {
                alert('Modal not found! There might be a DOM issue.');
                return;
            }
            
            const title = document.getElementById('exercise-modal-title');
            const nameInput = document.getElementById('exercise-name-input');
            const categorySelect = document.getElementById('exercise-category-select');
            
            console.log('Modal elements:', { title, nameInput, categorySelect });
            
            // Populate category dropdown
            categorySelect.innerHTML = '<option value="">Select muscle group...</option>';
            individualCategories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
            
            if (isEditMode) {
                title.textContent = 'Edit Exercise';
                // Load current exercise data
                db.collection('exercises').doc(exerciseId).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        nameInput.value = data.name || '';
                        categorySelect.value = data.individualCategory || '';
                    }
                });
            } else {
                title.textContent = 'Add Exercise';
                nameInput.value = '';
                categorySelect.value = '';
            }
            
            modal.style.display = 'block';
            nameInput.focus();
        }

        function closeExerciseModal() {
            document.getElementById('exercise-modal').style.display = 'none';
            currentCategoryId = null;
            currentExerciseId = null;
            isEditMode = false;
        }

        function saveExerciseFromModal() {
            const nameInput = document.getElementById('exercise-name-input');
            const categorySelect = document.getElementById('exercise-category-select');
            
            const exerciseName = nameInput.value.trim();
            const individualCategory = categorySelect.value;
            
            if (!exerciseName) {
                alert('Please enter an exercise name');
                return;
            }
            
            if (!individualCategory) {
                alert('Please select a muscle group category');
                return;
            }
            
            const exerciseData = {
                name: exerciseName,
                categoryId: currentCategoryId,
                individualCategory: individualCategory,
                userId: firebase.auth().currentUser.uid
            };
            
            if (isEditMode) {
                // Update existing exercise
                exerciseData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                
                db.collection('exercises').doc(currentExerciseId).update(exerciseData)
                .then(() => {
                    console.log('Exercise updated successfully');
                    closeExerciseModal();
                    loadExercises(currentCategoryId);
                    setTimeout(() => {
                        const selectElement = document.getElementById(`exercise-select-${currentCategoryId}`);
                        selectElement.value = currentExerciseId;
                        selectExercise(currentCategoryId, currentExerciseId);
                    }, 500);
                })
                .catch((error) => {
                    console.error('Error updating exercise:', error);
                    alert('Error updating exercise: ' + error.message);
                });
            } else {
                // Create new exercise
                const exerciseId = 'exercise_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                exerciseData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                
                db.collection('exercises').doc(exerciseId).set(exerciseData)
                .then(() => {
                    console.log('Exercise saved successfully');
                    closeExerciseModal();
                    loadExercises(currentCategoryId);
                    setTimeout(() => {
                        const selectElement = document.getElementById(`exercise-select-${currentCategoryId}`);
                        selectElement.value = exerciseId;
                        selectExercise(currentCategoryId, exerciseId);
                    }, 500);
                })
                .catch((error) => {
                    console.error('Error saving exercise:', error);
                    alert('Error saving exercise: ' + error.message);
                });
            }
        }

        function addExercise(categoryId) {
            console.log('addExercise called with categoryId:', categoryId);
            
            // Temporary fallback to prompt-based system
            const exerciseName = prompt('Enter exercise name:');
            if (!exerciseName || !exerciseName.trim()) {
                return;
            }
            
            const categoryOptions = individualCategories.map(cat => `${cat.id}: ${cat.name}`).join('\n');
            const selectedCategory = prompt(`Select muscle group by entering the ID:\n${categoryOptions}`);
            
            if (!selectedCategory || !individualCategories.find(cat => cat.id === selectedCategory)) {
                alert('Invalid category selected');
                return;
            }
            
            // Create unique ID
            const exerciseId = 'exercise_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Save to Firebase
            db.collection('exercises').doc(exerciseId).set({
                name: exerciseName.trim(),
                categoryId: categoryId,
                individualCategory: selectedCategory,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                userId: firebase.auth().currentUser.uid
            })
            .then(() => {
                console.log('Exercise saved successfully');
                loadExercises(categoryId);
                setTimeout(() => {
                    const selectElement = document.getElementById(`exercise-select-${categoryId}`);
                    selectElement.value = exerciseId;
                    selectExercise(categoryId, exerciseId);
                }, 500);
            })
            .catch((error) => {
                console.error('Error saving exercise:', error);
                alert('Error saving exercise: ' + error.message);
            });
        }

        function editExercise(categoryId) {
            console.log('editExercise called with categoryId:', categoryId);
            const selectElement = document.getElementById(`exercise-select-${categoryId}`);
            const exerciseId = selectElement.value;
            
            if (!exerciseId) {
                alert('Please select an exercise to edit');
                return;
            }
            
            // Get current exercise data
            db.collection('exercises').doc(exerciseId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    const newName = prompt('Enter new exercise name:', data.name || '');
                    if (!newName || !newName.trim()) {
                        return;
                    }
                    
                    const categoryOptions = individualCategories.map(cat => `${cat.id}: ${cat.name}`).join('\n');
                    const currentCategory = data.individualCategory || '';
                    const newCategory = prompt(`Select muscle group by entering the ID:\nCurrent: ${currentCategory}\n${categoryOptions}`, currentCategory);
                    
                    if (!newCategory || !individualCategories.find(cat => cat.id === newCategory)) {
                        alert('Invalid category selected');
                        return;
                    }
                    
                    // Update in Firebase
                    db.collection('exercises').doc(exerciseId).update({
                        name: newName.trim(),
                        individualCategory: newCategory,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        console.log('Exercise updated successfully');
                        loadExercises(categoryId);
                        setTimeout(() => {
                            selectElement.value = exerciseId;
                            selectExercise(categoryId, exerciseId);
                        }, 500);
                    })
                    .catch((error) => {
                        console.error('Error updating exercise:', error);
                        alert('Error updating exercise: ' + error.message);
                    });
                }
            }).catch((error) => {
                console.error('Error loading exercise:', error);
                alert('Error loading exercise: ' + error.message);
            });
        }

        function deleteSelectedExercise(categoryId) {
            const selectElement = document.getElementById(`exercise-select-${categoryId}`);
            const exerciseId = selectElement.value;
            
            if (!exerciseId) {
                alert('Please select an exercise to delete');
                return;
            }
            
            const exerciseName = selectElement.querySelector(`option[value="${exerciseId}"]`).textContent;
            
            if (!confirm(`Are you sure you want to delete "${exerciseName}"?`)) {
                return;
            }
            
            // Delete from Firebase
            db.collection('exercises').doc(exerciseId).delete()
            .then(() => {
                console.log('Exercise deleted successfully');
                // Refresh the exercises list
                loadExercises(categoryId);
                // Clear the exercise display
                const exerciseDisplay = document.getElementById(`selected-exercise-${categoryId}`);
                exerciseDisplay.classList.remove('active');
            })
            .catch((error) => {
                console.error('Error deleting exercise:', error);
                alert('Error deleting exercise: ' + error.message);
            });
        }

        function loadExercises(categoryId) {
            const selectElement = document.getElementById(`exercise-select-${categoryId}`);
            const user = firebase.auth().currentUser;
            
            if (!user) {
                console.error('No user logged in');
                selectElement.innerHTML = '<option value="">Please log in again</option>';
                return;
            }

            // Reset the select and hide the exercise display
            selectElement.innerHTML = '<option value="">Loading exercises...</option>';
            const exerciseDisplay = document.getElementById(`selected-exercise-${categoryId}`);
            exerciseDisplay.classList.remove('active');
            
            db.collection('exercises')
                .where('categoryId', '==', categoryId)
                .where('userId', '==', user.uid)
                .get()
                .then((snapshot) => {
                    selectElement.innerHTML = '<option value="">Select an exercise...</option>';
                    
                    if (snapshot.empty) {
                        selectElement.innerHTML = `<option value="">No exercises added yet for ${defaultCategories.find(c => c.id === categoryId)?.name || 'this category'}</option>`;
                        return;
                    }

                    // Populate the select dropdown with exercises
                    snapshot.forEach((doc) => {
                        const exercise = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = exercise.name;
                        selectElement.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error('Error loading exercises:', error);
                    selectElement.innerHTML = `<option value="">${error.message || 'Error loading exercises. Please try again.'}</option>`;
                });
        }

        async function getExerciseStats(exerciseId) {
            const user = firebase.auth().currentUser;
            if (!user) return null;

            try {
                // Get all workouts containing this exercise
                const workoutsSnapshot = await db.collection('workouts')
                    .where('userId', '==', user.uid)
                    .orderBy('date', 'desc')
                    .get();

                let lastWorkoutDate = null;
                let personalRecord = { weight: 0, reps: 0, volume: 0 };
                let lastWorkoutSets = [];

                workoutsSnapshot.forEach(doc => {
                    const workout = doc.data();
                    
                    // Check if this workout has categories and find the exercise
                    if (workout.categories && Array.isArray(workout.categories)) {
                        workout.categories.forEach(category => {
                            if (category.exercises && Array.isArray(category.exercises)) {
                                const exercise = category.exercises.find(ex => ex.exerciseId === exerciseId);
                                
                                if (exercise) {
                                    // Check for last workout date (first one since ordered by date desc)
                                    if (!lastWorkoutDate) {
                                        lastWorkoutDate = workout.date;
                                        lastWorkoutSets = exercise.sets || [];
                                    }

                                    // Check for personal records (highest weight with >= 7 reps)
                                    if (exercise.sets) {
                                        exercise.sets.forEach(set => {
                                            const weight = parseFloat(set.weight) || 0;
                                            const reps = parseInt(set.reps) || 0;
                                            
                                            if (reps >= 7 && weight > personalRecord.weight) {
                                                personalRecord.weight = weight;
                                                personalRecord.reps = reps;
                                                personalRecord.volume = weight * reps;
                                            }
                                        });
                                    }
                                }
                            }
                        });
                    }
                });

                console.log('Exercise stats found:', { lastWorkoutDate, personalRecord, lastWorkoutSets }); // Debug log

                return {
                    lastWorkoutDate,
                    personalRecord: personalRecord.weight > 0 ? personalRecord : null,
                    lastWorkoutSets
                };
            } catch (error) {
                console.error('Error getting exercise stats:', error);
                return null;
            }
        }

        function formatDutchDateTime(timestamp) {
            if (!timestamp) return 'Nog nooit gedaan';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Format the actual date as (10okt2025)
            const day = date.getDate();
            const months = ['jan', 'feb', 'mrt', 'apr', 'mei', 'jun', 
                           'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            const dateString = ` (${day}${month}${year})`;
            
            if (diffDays === 0) {
                return `Vandaag${dateString}`;
            } else if (diffDays === 1) {
                return `1 dag geleden${dateString}`;
            } else if (diffDays < 7) {
                return `${diffDays} dagen geleden${dateString}`;
            } else if (diffDays < 14) {
                return `1 week geleden${dateString}`;
            } else if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7);
                return `${weeks} weken geleden${dateString}`;
            } else if (diffDays < 60) {
                return `1 maand geleden${dateString}`;
            } else {
                const months = Math.floor(diffDays / 30);
                return `${months} maanden geleden${dateString}`;
            }
        }

        function autoFillLastWorkout(exerciseId, lastWorkoutSets) {
            // Fill in the sets from last workout
            for (let i = 1; i <= 3; i++) {
                const setInput = document.getElementById(`${exerciseId}_set${i}`);
                const kgInput = document.getElementById(`${exerciseId}_kg${i}`);
                
                if (setInput && kgInput) {
                    if (lastWorkoutSets && lastWorkoutSets[i - 1]) {
                        const lastSet = lastWorkoutSets[i - 1];
                        setInput.value = lastSet.reps || '';
                        kgInput.value = lastSet.weight || '';
                        
                        // Save to temporary data
                        saveTemporaryData(`${exerciseId}_set${i}`, lastSet.reps || '');
                        saveTemporaryData(`${exerciseId}_kg${i}`, lastSet.weight || '');
                    } else {
                        // Clear if no data for this set
                        setInput.value = '';
                        kgInput.value = '';
                        saveTemporaryData(`${exerciseId}_set${i}`, '');
                        saveTemporaryData(`${exerciseId}_kg${i}`, '');
                    }
                }
            }
        }

        function selectExercise(categoryId, exerciseId) {
            const exerciseDisplay = document.getElementById(`selected-exercise-${categoryId}`);
            const exerciseNameDisplay = document.getElementById(`selected-exercise-name-${categoryId}`);
            const exerciseSetsContainer = document.getElementById(`selected-exercise-sets-${categoryId}`);
            
            // If no exercise selected, hide the display
            if (!exerciseId) {
                exerciseDisplay.classList.remove('active');
                return;
            }
            
            // Get the exercise name from the select option
            const selectElement = document.getElementById(`exercise-select-${categoryId}`);
            const selectedOption = selectElement.querySelector(`option[value="${exerciseId}"]`);
            const exerciseName = selectedOption ? selectedOption.textContent : 'Unknown Exercise';
            
            // Display the selected exercise name with category indicator
            function updateExerciseNameWithCategory() {
                // Check if exercise has individual category
                let categoryIndicator = '';
                if (exerciseIndividualCategories[exerciseId]) {
                    const individualCategoryId = exerciseIndividualCategories[exerciseId];
                    const individualCategoryName = individualCategories.find(cat => cat.id === individualCategoryId)?.name || individualCategoryId;
                    categoryIndicator = ` <span style="color: #4CAF50; font-size: 0.75em; background: rgba(76, 175, 80, 0.1); padding: 1px 4px; border-radius: 3px; margin-left: 5px;">[${individualCategoryName}]</span>`;
                } else {
                    categoryIndicator = ` <span style="color: #FF5722; font-size: 0.75em; background: rgba(255, 87, 34, 0.1); padding: 1px 4px; border-radius: 3px; margin-left: 5px; cursor: pointer;" title="Individual category not set - click to edit exercise">‚ö†Ô∏è [Missing]</span>`;
                }
                
                exerciseNameDisplay.innerHTML = exerciseName + categoryIndicator;
            }
            
            // Initial display with just the name
            exerciseNameDisplay.textContent = exerciseName;
            
            // Cache the individual category for this exercise
            db.collection('exercises').doc(exerciseId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.individualCategory) {
                        exerciseIndividualCategories[exerciseId] = data.individualCategory;
                    }
                }
                // Update display with category indicator after loading
                updateExerciseNameWithCategory();
            }).catch(error => {
                console.error('Error loading exercise individual category:', error);
                // Still update display even if loading fails
                updateExerciseNameWithCategory();
            });
            
            // Load exercise statistics and setup the enhanced interface
            getExerciseStats(exerciseId).then(stats => {
                // Clear and rebuild the sets container with enhanced features
                exerciseSetsContainer.innerHTML = '';
                
                // Add exercise statistics
                const statsDiv = document.createElement('div');
                statsDiv.className = 'exercise-stats';
                
                const lastWorkoutText = stats ? formatDutchDateTime(stats.lastWorkoutDate) : 'Nog nooit gedaan';
                const prText = stats && stats.personalRecord 
                    ? `${stats.personalRecord.weight}kg √ó ${stats.personalRecord.reps} reps (${stats.personalRecord.volume}kg vol.)`
                    : 'Geen record (‚â•7 reps)';
                
                statsDiv.innerHTML = `
                    <div class="stat-row">
                        <span class="stat-label">Laatste workout:</span> <span class="stat-value">${lastWorkoutText}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Pers. Record:</span> <span class="stat-value">${prText}</span>
                    </div>
                `;
                exerciseSetsContainer.appendChild(statsDiv);
                
                // Add auto-fill button
                const autoFillBtn = document.createElement('button');
                autoFillBtn.className = 'autofill-button';
                autoFillBtn.innerHTML = '‚ö° Vul laatste workout in';
                autoFillBtn.disabled = !stats || !stats.lastWorkoutSets || stats.lastWorkoutSets.length === 0;
                autoFillBtn.onclick = () => autoFillLastWorkout(exerciseId, stats.lastWorkoutSets);
                exerciseSetsContainer.appendChild(autoFillBtn);
                
                // Add notes field
                const notesDiv = document.createElement('div');
                notesDiv.className = 'exercise-notes';
                notesDiv.innerHTML = `
                    <label for="notes-${exerciseId}">Notities (bv. "stoel hoogte 6"):</label>
                    <textarea 
                        id="notes-${exerciseId}" 
                        placeholder="Voer hier je notities in..."
                        onchange="saveExerciseNotes('${exerciseId}', this.value)"
                        onblur="saveExerciseNotes('${exerciseId}', this.value)"
                        oninput="markNotesAsUnsaved('${exerciseId}')"
                    ></textarea>
                    <small id="notes-status-${exerciseId}" style="color: #aaa; font-size: 12px; margin-top: 3px; display: block;"></small>
                `;
                exerciseSetsContainer.appendChild(notesDiv);
                
                // Load existing notes for this exercise
                loadExerciseNotes(exerciseId);
                
                // Create sets inputs for the selected exercise
                for (let i = 1; i <= 3; i++) {
                    const setRow = document.createElement('div');
                    setRow.className = 'set-row';
                    const setInputId = `${exerciseId}_set${i}`;
                    const kgInputId = `${exerciseId}_kg${i}`;
                    
                    setRow.innerHTML = `
                        <input 
                            type="number" 
                            class="set-input" 
                            id="${setInputId}"
                            placeholder="Set ${i}" 
                            min="0"
                            value="${exerciseData[setInputId] || ''}"
                            onchange="saveTemporaryData('${setInputId}', this.value)"
                        >
                        <input 
                            type="number" 
                            class="set-input" 
                            id="${kgInputId}"
                            placeholder="Kg" 
                            min="0" 
                            step="0.5"
                            value="${exerciseData[kgInputId] || ''}"
                            onchange="saveTemporaryData('${kgInputId}', this.value)"
                        >
                    `;
                    exerciseSetsContainer.appendChild(setRow);
                }
                
                // Show the exercise display
                exerciseDisplay.classList.add('active');
                
                // Store the selected exercise ID for other functions to use
                window.selectedExerciseId = exerciseId;
                
                // Update the daily exercise counter
                updateDailyExerciseCounter();
            });
        }

        async function saveExerciseNotes(exerciseId, notes) {
            const statusElement = document.getElementById(`notes-status-${exerciseId}`);
            if (statusElement) {
                statusElement.textContent = 'Opslaan...';
                statusElement.style.color = '#ffd700';
            }
            
            try {
                await db.collection('exercises').doc(exerciseId).update({
                    notes: notes.trim(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Exercise notes saved successfully');
                
                if (statusElement) {
                    statusElement.textContent = 'Opgeslagen ‚úì';
                    statusElement.style.color = '#4CAF50';
                    setTimeout(() => {
                        statusElement.textContent = '';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error saving exercise notes:', error);
                if (statusElement) {
                    statusElement.textContent = 'Fout bij opslaan';
                    statusElement.style.color = '#ff4444';
                }
            }
        }

        function markNotesAsUnsaved(exerciseId) {
            const statusElement = document.getElementById(`notes-status-${exerciseId}`);
            if (statusElement) {
                statusElement.textContent = 'Niet opgeslagen...';
                statusElement.style.color = '#aaa';
            }
        }

        async function loadExerciseNotes(exerciseId) {
            try {
                const doc = await db.collection('exercises').doc(exerciseId).get();
                if (doc.exists) {
                    const exerciseData = doc.data();
                    const notesField = document.getElementById(`notes-${exerciseId}`);
                    if (notesField && exerciseData.notes) {
                        notesField.value = exerciseData.notes;
                    }
                }
            } catch (error) {
                console.error('Error loading exercise notes:', error);
            }
        }

        // Function to update daily exercise counter - queries database for today's saved workouts
        function updateDailyExerciseCounter() {
            console.log("=== updateDailyExerciseCounter START (Database Query Version) ===");
            
            // Check if user is authenticated
            const user = firebase.auth().currentUser;
            if (!user) {
                console.log("User not authenticated, showing 0 exercises");
                updateCounterDisplay({}, 0);
                return;
            }
            
            console.log("User authenticated:", user.uid);
            
            // Get today's date in YYYY-MM-DD format
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            
            console.log("Today's date object:", today);
            console.log("Formatted date string:", todayStr);
            console.log("Querying workouts for user:", user.uid, "date:", todayStr);
            
            // First, let's see what dates exist in the database for this user
            db.collection('workouts')
                .where('userId', '==', user.uid)
                .get()
                .then(allWorkouts => {
                    console.log("All workouts in database for user:");
                    allWorkouts.forEach(doc => {
                        const data = doc.data();
                        console.log("- Workout ID:", doc.id, "Date:", data.date, "Categories:", data.categories?.length || 0);
                    });
                });
            
            // Query today's workouts from database - check both timestamp and date string formats
            Promise.all([
                // Query by today's date string (if any exist in this format)
                db.collection('workouts')
                    .where('userId', '==', user.uid)
                    .where('date', '==', todayStr)
                    .get(),
                // Query by timestamp range for today
                db.collection('workouts')
                    .where('userId', '==', user.uid)
                    .where('date', '>=', new Date(todayStr))
                    .where('date', '<', new Date(todayStr + 'T23:59:59'))
                    .get()
            ]).then(([stringDateResults, timestampResults]) => {
                console.log("String date results:", stringDateResults.size);
                console.log("Timestamp results:", timestampResults.size);
                
                // Combine both results (avoid duplicates)
                const allDocs = new Map();
                stringDateResults.forEach(doc => allDocs.set(doc.id, doc));
                timestampResults.forEach(doc => allDocs.set(doc.id, doc));
                
                console.log("Total unique workouts for today:", allDocs.size);
                
                const categoryCounts = {};
                let totalExercises = 0;
                
                allDocs.forEach((doc) => {
                    const workoutData = doc.data();
                    console.log("Processing workout:", doc.id, workoutData);
                    
                    // Handle new format with exercises array
                    if (workoutData.exercises && Array.isArray(workoutData.exercises)) {
                        workoutData.exercises.forEach(exercise => {
                            console.log("Processing exercise (new format):", exercise.name, "Individual category:", exercise.individualCategory);
                            
                            if (exercise.individualCategory) {
                                const categoryName = individualCategories.find(cat => cat.id === exercise.individualCategory)?.name || exercise.individualCategory;
                                categoryCounts[categoryName] = (categoryCounts[categoryName] || 0) + 1;
                                totalExercises++;
                                console.log(`Incremented ${categoryName} to:`, categoryCounts[categoryName]);
                            }
                        });
                    }
                    
                    // Handle old format with categories array  
                    if (workoutData.categories && Array.isArray(workoutData.categories)) {
                        workoutData.categories.forEach(category => {
                            console.log("Processing category (old format):", category.name);
                            
                            if (category.exercises && Array.isArray(category.exercises)) {
                                category.exercises.forEach(exercise => {
                                    console.log("Processing exercise in category:", exercise.name, "Exercise ID:", exercise.exerciseId);
                                    
                                    // For old format, we need to look up the individual category from the exercise ID
                                    if (exercise.exerciseId && exerciseIndividualCategories[exercise.exerciseId]) {
                                        const individualCategoryId = exerciseIndividualCategories[exercise.exerciseId];
                                        const categoryName = individualCategories.find(cat => cat.id === individualCategoryId)?.name || individualCategoryId;
                                        categoryCounts[categoryName] = (categoryCounts[categoryName] || 0) + 1;
                                        totalExercises++;
                                        console.log(`Incremented ${categoryName} to:`, categoryCounts[categoryName]);
                                    } else {
                                        // Fallback: use the category name directly (old behavior)
                                        const categoryName = category.name;
                                        if (categoryName) {
                                            // Handle combined categories like "Chest and Triceps"
                                            if (categoryName.includes(' and ') || categoryName.includes(' & ')) {
                                                const parsedCategories = categoryName.split(/ and | & /);
                                                parsedCategories.forEach(cat => {
                                                    const cleanCat = cat.trim();
                                                    categoryCounts[cleanCat] = (categoryCounts[cleanCat] || 0) + 1;
                                                });
                                                totalExercises += parsedCategories.length;
                                            } else {
                                                categoryCounts[categoryName] = (categoryCounts[categoryName] || 0) + 1;
                                                totalExercises++;
                                            }
                                        }
                                    }
                                });
                            }
                        });
                    }
                });
                
                console.log("Final database counts:", categoryCounts, "Total:", totalExercises);
                
                // Update the counter display
                updateCounterDisplay(categoryCounts, totalExercises);
            })
                .catch(error => {
                    console.error('Error querying today\'s workouts:', error);
                    
                    // Fallback to showing 0
                    updateCounterDisplay({}, 0);
                });
            
            console.log("=== updateDailyExerciseCounter END ===");
        }

        function updateCounterDisplay(categoryCounts, totalExercises) {
            const counterContent = document.getElementById('counter-content');
            if (totalExercises === 0) {
                counterContent.innerHTML = 'Today: 0 exercises';
            } else {
                const categoryText = Object.entries(categoryCounts)
                    .map(([category, count]) => `${category}: ${count}`)
                    .join(' ‚Ä¢ ');
                counterContent.innerHTML = `Today: ${categoryText} (${totalExercises} total)`;
            }
        }

        // Add this function after your existing functions

async function saveWorkout() {
    const user = firebase.auth().currentUser;
    if (!user) {
        alert('Please log in to save your workout');
        return;
    }

    const allCategories = document.querySelectorAll('.exercise-container');
    let workoutData = {
        userId: user.uid,
        date: firebase.firestore.FieldValue.serverTimestamp(),
        categories: []
    };

    let hasData = false;

    // Check all active categories for exercises
    allCategories.forEach((categoryContainer) => {
        const categoryId = categoryContainer.id.replace('exercise-container-', '');
        const categoryExercises = [];

        // Check if this category has a selected exercise with input data
        const selectedExerciseDisplay = categoryContainer.querySelector('.selected-exercise-display.active');
        if (selectedExerciseDisplay) {
            const exerciseNameElement = selectedExerciseDisplay.querySelector('.selected-exercise-name');
            const exerciseName = exerciseNameElement ? exerciseNameElement.textContent.trim() : '';
            
            // Get the exercise ID from the select dropdown
            const selectElement = categoryContainer.querySelector('.exercise-select');
            const exerciseId = selectElement ? selectElement.value : '';
            
            if (exerciseName && exerciseId) {
                const sets = [];

                // Collect data from each set
                for (let i = 1; i <= 3; i++) {
                    const setInputId = `${exerciseId}_set${i}`;
                    const kgInputId = `${exerciseId}_kg${i}`;
                    
                    // Get values from input fields or from saved exerciseData as fallback
                    const setInput = document.getElementById(setInputId);
                    const kgInput = document.getElementById(kgInputId);
                    const repsValue = setInput?.value || exerciseData[setInputId] || '';
                    const weightValue = kgInput?.value || exerciseData[kgInputId] || '';
                    
                    if (repsValue || weightValue) {
                        sets.push({
                            setNumber: i,
                            reps: repsValue || null,
                            weight: weightValue || null
                        });
                        hasData = true;
                    }
                }

                if (sets.length > 0) {
                    categoryExercises.push({
                        exerciseId: exerciseId,
                        name: exerciseName,
                        sets: sets
                    });
                }
            }
        }

        // Only add category if it has exercises with data
        if (categoryExercises.length > 0) {
            workoutData.categories.push({
                categoryId: categoryId,
                name: defaultCategories.find(c => c.id === categoryId)?.name || '',
                exercises: categoryExercises
            });
        }
    });

    if (!hasData) {
        alert('Please fill in at least one set before saving');
        return;
    }

    try {
        // Save to workouts collection
        await db.collection('workouts').add(workoutData);
        
        // Show success message
        alert('Workout saved successfully!');
        
        // Clear all inputs but keep exercises selected
        document.querySelectorAll('.exercise-container').forEach((categoryContainer) => {
            const selectElement = categoryContainer.querySelector('.exercise-select');
            const exerciseId = selectElement ? selectElement.value : '';
            
            if (exerciseId) {
                for (let i = 1; i <= 3; i++) {
                    const setInput = document.getElementById(`${exerciseId}_set${i}`);
                    const kgInput = document.getElementById(`${exerciseId}_kg${i}`);
                    if (setInput) setInput.value = '';
                    if (kgInput) kgInput.value = '';
                    
                    // Clear from exerciseData as well
                    delete exerciseData[`${exerciseId}_set${i}`];
                    delete exerciseData[`${exerciseId}_kg${i}`];
                }
            }
        });
        
        // Update localStorage
        localStorage.setItem('exerciseData', JSON.stringify(exerciseData));
        
        // Update the counter
        updateDailyExerciseCounter();
        
    } catch (error) {
        console.error('Error saving workout:', error);
        alert('Error saving workout: ' + error.message);
    }
}
        // Add this line right after your Firebase initialization
        loadSavedData();  // Load saved data when page initializes

        // Add these functions to handle workout history
        function viewHistory() {
            document.getElementById('workout-history-modal').style.display = 'block';
            populateCategoryButtons();
            loadWorkoutHistory(7); // Default to 1 week
        }

        // Workout Progress Module
        function viewProgress() {
            showWorkoutProgressModal();
        }

        function showWorkoutProgressModal() {
            if (!document.getElementById('workout-progress-modal')) {
                // Create modal if not exists
                const modal = document.createElement('div');
                modal.id = 'workout-progress-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close-btn" onclick="document.getElementById('workout-progress-modal').style.display='none'">√ó</button>
                        <h2 style="margin-bottom:20px;">Workout Progress</h2>
                        <div style="display:grid;grid-template-columns:repeat(2, 1fr) repeat(2, 1fr);gap:6px;margin-bottom:15px;">
                                <button onclick="loadWorkoutProgress(7)" class="period-btn active">1 Week</button>
                                <button onclick="loadWorkoutProgress(30)" class="period-btn">1 Month</button>
                                <button onclick="loadWorkoutProgress(180)" class="period-btn">6 Months</button>
                                <button onclick="loadWorkoutProgress(365)" class="period-btn">1 Year</button>
                        </div>
                        <div id="progress-category-buttons" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:20px;"></div>
                        <div id="workout-progress-content" style="max-height:400px;overflow-y:auto;margin-bottom:20px;"></div>
                    </div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('workout-progress-modal').style.display = 'block';
            populateProgressCategoryButtons();
            loadWorkoutProgress(7); // Default to 1 week
        }

        function populateProgressCategoryButtons() {
            const container = document.getElementById('progress-category-buttons');
            let html = `<button onclick="filterProgressByCategory('all')" class="category-filter-btn active">All</button>`;
            defaultCategories.forEach(cat => {
                html += `<button onclick="filterProgressByCategory('${cat.id}')" class="category-filter-btn">${cat.name}</button>`;
            });
            container.innerHTML = html;
        }

    // Declare currentProgressCategory only once at the top level
    var currentProgressCategory = 'all';
    // Declare currentProgressData only once at the top level
    var currentProgressData = [];

        function filterProgressByCategory(categoryId) {
            document.querySelectorAll('#progress-category-buttons .category-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#progress-category-buttons [onclick*=filterProgressByCategory][onclick*='${categoryId}']`).classList.add('active');
            currentProgressCategory = categoryId;
            displayWorkoutProgress(currentProgressData);
        }

        function loadWorkoutProgress(days) {
            // Update active button
            const btns = document.querySelectorAll('#workout-progress-modal .period-btn');
            btns.forEach(btn => {
                btn.classList.remove('active');
                const match = btn.getAttribute('onclick').match(/loadWorkoutProgress\((\d+)\)/);
                if (match && parseInt(match[1]) === days) {
                    btn.classList.add('active');
                }
            });
            const progressContent = document.getElementById('workout-progress-content');
            const user = firebase.auth().currentUser;
            if (!user) {
                progressContent.innerHTML = '<p style="text-align:center;color:#ff4444;">Please log in to view progress</p>';
                return;
            }
            progressContent.innerHTML = '<p style="text-align:center;">Loading...</p>';
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            db.collection('workouts')
                .where('userId', '==', user.uid)
                .orderBy('date', 'asc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        progressContent.innerHTML = '<p style="text-align:center;color:#666;">No workouts found</p>';
                        return;
                    }
                    let workouts = [];
                    snapshot.forEach(doc => {
                        const workout = doc.data();
                        if (workout.date && workout.date.toDate() >= startDate) {
                            workouts.push({...workout, date: workout.date.toDate()});
                        }
                    });
                    currentProgressData = workouts;
                    displayWorkoutProgress(workouts);
                })
                .catch(error => {
                    console.error('Error loading workout progress:', error);
                    progressContent.innerHTML = `<p style="text-align:center;color:#ff4444;">Error loading progress: ${error.message}</p>`;
                });
        }

        function displayWorkoutProgress(workouts) {
            const progressContent = document.getElementById('workout-progress-content');
            let filtered = workouts;
            if (currentProgressCategory !== 'all') {
                filtered = workouts.filter(w => w.categories && w.categories.some(c => c.categoryId === currentProgressCategory));
            }
            // Collect exercise progress by name
            let exerciseMap = {};
            filtered.forEach(workout => {
                if (!workout.categories) return;
                workout.categories.forEach(category => {
                    if (currentProgressCategory !== 'all' && category.categoryId !== currentProgressCategory) return;
                    if (!category.exercises) return;
                    category.exercises.forEach(ex => {
                        if (!ex.name) return;
                        if (!exerciseMap[ex.name]) exerciseMap[ex.name] = [];
                        let sessionTotalVolume = 0;
                        let sessionBestSet = 0;
                        let sessionHighestWeight = 0;
                        ex.sets.forEach(set => {
                            const reps = Number(set.reps) || 0;
                            const weight = Number(set.weight) || 0;
                            const setVolume = reps * weight;
                            sessionTotalVolume += setVolume;
                            if (setVolume > sessionBestSet) sessionBestSet = setVolume;
                            if (weight > sessionHighestWeight) sessionHighestWeight = weight;
                        });
                        exerciseMap[ex.name].push({date: workout.date, totalVolume: sessionTotalVolume, bestSet: sessionBestSet, highestWeight: sessionHighestWeight});
                    });
                });
            });
            // Chart for each exercise
            let html = '';
            Object.keys(exerciseMap).forEach(exName => {
                const dataArr = exerciseMap[exName];
                if (dataArr.length < 2) return; // Need at least 2 points for trend
                // Sort by date
                dataArr.sort((a,b)=>a.date-b.date);
                // Prepare chart data
                const labels = dataArr.map(d=>`${d.date.toLocaleDateString()}`);
                const volumes = dataArr.map(d=>d.totalVolume);
                const repsArr = dataArr.map(d=>{
                    // Sum all reps for this session
                    let reps = 0;
                    if (workouts && Array.isArray(workouts)) {
                        // Find the matching workout for this date
                        const workout = workouts.find(w => w.date.getTime() === d.date.getTime());
                        if (workout && workout.categories) {
                            workout.categories.forEach(category => {
                                if (category.exercises) {
                                    category.exercises.forEach(ex => {
                                        if (ex.name === exName && ex.sets) {
                                            ex.sets.forEach(set => {
                                                reps += Number(set.reps) || 0;
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    }
                    return reps;
                });
                // Trend
                const volumeDiff = volumes[volumes.length-1] - volumes[0];
                const trendIcon = volumeDiff > 0 ? 'üìà' : volumeDiff < 0 ? 'üìâ' : '‚û°Ô∏è';
                // Calculate best set, total volume, highest weight, and monthly averages
                const bestSet = Math.max(...dataArr.map(d=>d.bestSet));
                const highestWeight = Math.max(...dataArr.map(d=>d.highestWeight));
                const totalVolume = volumes.reduce((a,b)=>a+b,0);
                // Monthly averages
                let monthlyMap = {};
                dataArr.forEach(d => {
                    const monthKey = `${d.date.getFullYear()}-${d.date.getMonth()+1}`;
                    if (!monthlyMap[monthKey]) monthlyMap[monthKey] = [];
                    monthlyMap[monthKey].push(d.totalVolume);
                });
                let monthlyAverages = Object.entries(monthlyMap).map(([month, arr]) => {
                    const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
                    return {month, avg};
                });
                let monthlyCompare = '';
                if (monthlyAverages.length > 1) {
                    const last = monthlyAverages[monthlyAverages.length-1].avg;
                    const prev = monthlyAverages[monthlyAverages.length-2].avg;
                    const diff = last - prev;
                    monthlyCompare = `Monthly avg change: <span style="color:${diff>0?'#4CAF50':'#ff4444'};font-weight:bold;">${diff>0?'+':''}${diff.toFixed(1)}kg</span>`;
                }
                html += `<div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:8px;margin-bottom:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <span style="font-weight:bold;font-size:1.1em;">${exName}</span>
                        <span style="color:${volumeDiff>0?'#4CAF50':'#ff4444'};font-weight:bold;">${trendIcon} ${volumeDiff>0?'+':''}${volumeDiff.toFixed(1)}kg</span>
                    </div>
                    <canvas id="chart-${exName.replace(/\s/g,'-')}"></canvas>
                    <div style='margin-top:10px;'>
                        <table style='width:100%;font-size:0.95em;background:rgba(255,255,255,0.05);border-radius:6px;'>
                            <thead>
                                <tr style='color:#ffd700;'>
                                    <th style='text-align:left;padding:4px;'>Date</th>
                                    <th style='text-align:right;padding:4px;'>Best set (kg)</th>
                                    <th style='text-align:right;padding:4px;'>Total volume (kg)</th>
                                    <th style='text-align:right;padding:4px;'>Highest weight (kg)</th>
                                    <th style='text-align:right;padding:4px;'>Total reps</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dataArr.map(d => {
                                    // Calculate total reps for this session
                                    let reps = 0;
                                    if (workouts && Array.isArray(workouts)) {
                                        const workout = workouts.find(w => w.date.getTime() === d.date.getTime());
                                        if (workout && workout.categories) {
                                            workout.categories.forEach(category => {
                                                if (category.exercises) {
                                                    category.exercises.forEach(ex => {
                                                        if (ex.name === exName && ex.sets) {
                                                            ex.sets.forEach(set => {
                                                                reps += Number(set.reps) || 0;
                                                            });
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                    }
                                    return `<tr>
                                        <td style='padding:4px;'>${d.date.toLocaleDateString()}</td>
                                        <td style='text-align:right;padding:4px;'>${d.bestSet}</td>
                                        <td style='text-align:right;padding:4px;'>${d.totalVolume}</td>
                                        <td style='text-align:right;padding:4px;'>${d.highestWeight}</td>
                                        <td style='text-align:right;padding:4px;'>${reps}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                        <div style='color:#888;font-size:0.9em;margin-top:4px;'>
                            <b>Best set:</b> Highest volume of a single set (reps √ó weight) in this session.<br>
                            <b>Total volume:</b> Sum of all sets (reps √ó weight) in this session.<br>
                            <b>Highest weight:</b> Maximum weight used in any single set in this session.<br>
                            <b>Total reps:</b> Sum of all reps for this exercise in this session.
                        </div>
                    </div>
                    <div style="margin-top:2px;color:#2196F3;font-size:0.95em;">${monthlyCompare}</div>
                </div>`;
            });
            if (!html) html = '<p style="text-align:center;color:#666;">No progress data for selected criteria</p>';
            progressContent.innerHTML = html;
            // Render charts
            Object.keys(exerciseMap).forEach(exName => {
                const dataArr = exerciseMap[exName];
                if (dataArr.length < 2) return;
                const labels = dataArr.map(d=>`${d.date.toLocaleDateString()}`);
                const volumes = dataArr.map(d=>d.totalVolume);
                const repsArr = dataArr.map(d=>{
                    // Sum all reps for this session
                    let reps = 0;
                    if (workouts && Array.isArray(workouts)) {
                        // Find the matching workout for this date
                        const workout = workouts.find(w => w.date.getTime() === d.date.getTime());
                        if (workout && workout.categories) {
                            workout.categories.forEach(category => {
                                if (category.exercises) {
                                    category.exercises.forEach(ex => {
                                        if (ex.name === exName && ex.sets) {
                                            ex.sets.forEach(set => {
                                                reps += Number(set.reps) || 0;
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    }
                    return reps;
                });
                const ctx = document.getElementById(`chart-${exName.replace(/\s/g,'-')}`);
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Total Volume (kg)',
                                    data: volumes,
                                    borderColor: '#ffd700',
                                    backgroundColor: 'rgba(255,215,0,0.1)',
                                    tension: 0.3,
                                    fill: true
                                },
                                {
                                    label: 'Total Reps',
                                    data: repsArr,
                                    borderColor: '#2196F3',
                                    backgroundColor: 'rgba(33,150,243,0.1)',
                                    tension: 0.3,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {legend:{position:'top'}},
                            scales: {
                                y: {beginAtZero:true,grid:{color:'rgba(255,255,255,0.1)'}},
                                x: {grid:{color:'rgba(255,255,255,0.1)'}}
                            }
                        }
                    });
                }
            });
        }

        function populateCategoryButtons() {
            const categoryButtonsContainer = document.getElementById('category-filter-buttons');
            let html = `<button onclick="filterWorkoutsByCategory('all')" class="category-filter-btn active">All</button>`;
            
            defaultCategories.forEach(cat => {
                html += `
                    <button 
                        onclick="filterWorkoutsByCategory('${cat.id}')" 
                        class="category-filter-btn"
                    >${cat.name}</button>
                `;
            });
            
            categoryButtonsContainer.innerHTML = html;
        }

        function loadWorkoutHistory(days) {
            // Update active button
            const btns = document.querySelectorAll('#workout-history-modal .period-btn');
            btns.forEach(btn => {
                btn.classList.remove('active');
                const match = btn.getAttribute('onclick').match(/loadWorkoutHistory\((\d+)\)/);
                if (match && parseInt(match[1]) === days) {
                    btn.classList.add('active');
                }
            });
            const historyContent = document.getElementById('workout-history-content');
            const user = firebase.auth().currentUser;
            
            if (!user) {
                historyContent.innerHTML = '<p style="text-align: center; color: #ff4444;">Please log in to view history</p>';
                return;
            }

            historyContent.innerHTML = '<p style="text-align: center;">Loading...</p>';

            // Calculate date range
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            db.collection('workouts')
                .where('userId', '==', user.uid)
                .orderBy('date', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        historyContent.innerHTML = '<p style="text-align: center; color: #666;">No workouts found</p>';
                        return;
                    }

                    currentWorkouts = [];
                    snapshot.forEach(doc => {
                        const workout = doc.data();
                        if (workout.date.toDate() >= startDate) {
                            currentWorkouts.push({
                                id: doc.id,
                                ...workout
                            });
                        }
                    });

                    displayWorkouts(currentWorkouts);
                })
                .catch(error => {
                    console.error('Error loading workout history:', error);
                    historyContent.innerHTML = `
                        <p style="text-align: center; color: #ff4444;">
                            Error loading workout history: ${error.message}
                        </p>
                    `;
                });
        }

        function filterWorkoutsByCategory(categoryId) {
            // Update active category button
            document.querySelectorAll('.category-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="filterWorkoutsByCategory('${categoryId}')"]`).classList.add('active');

            currentCategoryFilter = categoryId;
            displayWorkouts(currentWorkouts);
        }

        function displayWorkouts(workouts) {
            const historyContent = document.getElementById('workout-history-content');
            let html = '<div style="display: grid; gap: 15px;">';

            // Group workouts by date (YYYY-MM-DD)
            const grouped = {};
            workouts.forEach(workout => {
                if (!workout.categories || !Array.isArray(workout.categories)) return;
                const dateObj = workout.date.toDate();
                const dateStr = dateObj.toLocaleDateString();
                if (!grouped[dateStr]) grouped[dateStr] = [];
                grouped[dateStr].push(workout);
            });

            Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).forEach(dateStr => {
                // First, check if there are any exercises for the selected category on this date
                const categoryMap = {};
                grouped[dateStr].forEach(workout => {
                    const categories = workout.categories.filter(cat => currentCategoryFilter === 'all' || cat.categoryId === currentCategoryFilter);
                    categories.forEach(category => {
                        if (!category || !category.name || !category.exercises) return;
                        if (!categoryMap[category.name]) categoryMap[category.name] = [];
                        categoryMap[category.name].push(...category.exercises);
                    });
                });

                // Only show the date if there are exercises for the selected category
                if (Object.keys(categoryMap).length > 0) {
                    const [day, month, year] = dateStr.split(/[\/\-\.]/).map(Number);
                    const dateObj = new Date(year, month - 1, day);
                    const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                    
                    // Calculate individual category counters using exercise cache
                    const categoryCounts = {};
                    Object.keys(categoryMap).forEach(categoryName => {
                        categoryMap[categoryName].forEach(exercise => {
                            // Try to get individual category from cache first
                            if (exercise.exerciseId && exerciseIndividualCategories[exercise.exerciseId]) {
                                const individualCategoryId = exerciseIndividualCategories[exercise.exerciseId];
                                const individualCategoryName = individualCategories.find(cat => cat.id === individualCategoryId)?.name || individualCategoryId;
                                categoryCounts[individualCategoryName] = (categoryCounts[individualCategoryName] || 0) + 1;
                                console.log(`History: Found individual category for ${exercise.name}: ${individualCategoryName}`);
                            } else {
                                // Fallback: Handle combined categories by parsing the category name
                                console.log(`History: No individual category found for ${exercise.name}, using fallback parsing for ${categoryName}`);
                                
                                // Enhanced parsing for various separator formats
                                let parsedCategories = [];
                                if (categoryName.includes(' and ') || categoryName.includes(' & ') || categoryName.includes(', ')) {
                                    // Split by multiple possible separators
                                    parsedCategories = categoryName.split(/ and | & |, |,/).map(cat => cat.trim()).filter(cat => cat.length > 0);
                                } else {
                                    parsedCategories = [categoryName];
                                }
                                
                                // Map common variations to standard names
                                const categoryMapping = {
                                    'biceps': 'Biceps',
                                    'shoulder': 'Shoulders', 
                                    'shoulders': 'Shoulders',
                                    'back': 'Back',
                                    'abs': 'Abs',
                                    'core': 'Abs', // Map Core to Abs since they're similar
                                    'chest': 'Chest',
                                    'triceps': 'Triceps',
                                    'legs': 'Legs'
                                };
                                
                                parsedCategories.forEach(cat => {
                                    const cleanCat = cat.trim();
                                    const standardName = categoryMapping[cleanCat.toLowerCase()] || cleanCat;
                                    categoryCounts[standardName] = (categoryCounts[standardName] || 0) + 1;
                                    console.log(`History: Mapped ${cleanCat} -> ${standardName}`);
                                });
                            }
                        });
                    });
                    
                    const totalExercises = Object.values(categoryCounts).reduce((sum, count) => sum + count, 0);
                    const categoryCountText = Object.entries(categoryCounts)
                        .map(([category, count]) => `${category}: ${count}`)
                        .join(' ‚Ä¢ ');
                    
                    html += `<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">${dateStr} <span style='color:black;'>${dayName}</span></div>
                        <div style="margin-bottom: 15px; padding: 8px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; text-align: center; font-size: 13px; color: #ffd700; font-weight: 500;">
                            ${categoryCountText} (${totalExercises} total)
                        </div>`;

                    Object.keys(categoryMap).forEach(categoryName => {
                        html += `<div style="margin-bottom: 10px;"><div style="color: #ffd700; margin-bottom: 5px; font-weight: bold;">${categoryName}</div>`;
                        categoryMap[categoryName].forEach(exercise => {
                            if (!exercise || !exercise.name || !exercise.sets) return;
                            
                            // Check if exercise has individual category
                            let categoryIndicator = '';
                            if (exercise.exerciseId && exerciseIndividualCategories[exercise.exerciseId]) {
                                const individualCategoryId = exerciseIndividualCategories[exercise.exerciseId];
                                const individualCategoryName = individualCategories.find(cat => cat.id === individualCategoryId)?.name || individualCategoryId;
                                categoryIndicator = `<span style="color: #4CAF50; font-size: 0.8em; margin-left: 8px; background: rgba(76, 175, 80, 0.1); padding: 2px 6px; border-radius: 4px;">[${individualCategoryName}]</span>`;
                            } else {
                                categoryIndicator = `<span style="color: #FF5722; font-size: 0.8em; margin-left: 8px; background: rgba(255, 87, 34, 0.1); padding: 2px 6px; border-radius: 4px; cursor: pointer;" title="Individual category not set - needs to be updated">‚ö†Ô∏è [Missing Category]</span>`;
                            }
                            
                            html += `<div style="margin-left: 15px; margin-bottom: 8px;"><div style="font-weight: 500; display: flex; align-items: center;">${exercise.name}${categoryIndicator}</div><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 5px; margin-left: 15px; color: #666; font-size: 0.9em;">`;
                            exercise.sets.forEach(set => {
                                if (!set) return;
                                html += `<div>Set ${set.setNumber}: ${set.reps || '0'} √ó ${set.weight || '0'}kg</div>`;
                            });
                            html += `</div></div>`;
                        });
                        html += `</div>`;
                    });

                    html += `</div>`;
                }
            });

    if (html === '<div style="display: grid; gap: 15px;">') {
        html += '<p style="text-align: center; color: #666;">No workouts found for selected criteria</p>';
    }

    html += '</div>';
    historyContent.innerHTML = html;
}

        function showBodyWeightModal() {
            document.getElementById('body-weight-modal').style.display = 'block';
        }

        function closeBodyWeightModal() {
            document.getElementById('body-weight-modal').style.display = 'none';
        }

        function closeWeightHistory() {
            document.getElementById('weight-history-modal').style.display = 'none';
        }

        function closeWeightProgress() {
            document.getElementById('weight-progress-modal').style.display = 'none';
        }

        function saveBodyWeight() {
            const weightInput = document.getElementById('body-weight-input');
            const weight = weightInput.value;
            
            if (!weight) {
                alert('Please enter your weight');
                return;
            }

            const user = firebase.auth().currentUser;
            if (!user) {
                alert('Please log in to save your weight');
                return;
            }

            db.collection('bodyweights').add({
                userId: user.uid,
                weight: parseFloat(weight),
                date: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                alert('Weight saved successfully!');
                weightInput.value = '';
            })
            .catch(error => {
                console.error('Error saving weight:', error);
                alert('Error saving weight');
            });
        }

        function showWeightHistory() {
            document.getElementById('body-weight-modal').style.display = 'none';
            document.getElementById('weight-history-modal').style.display = 'block';
            loadWeightHistory(7); // Default to 1 week
        }

        // Body Weight History Module
        function loadWeightHistory(days) {
            const historyContent = document.getElementById('weight-history-content');
            // Update active button
            const btns = document.querySelectorAll('#weight-history-modal .period-btn');
            btns.forEach(btn => {
                btn.classList.remove('active');
                // Extract days from onclick attribute
                const match = btn.getAttribute('onclick').match(/loadWeightHistory\((\d+)\)/);
                if (match && parseInt(match[1]) === days) {
                    btn.classList.add('active');
                }
            });
            const user = firebase.auth().currentUser;
            if (!user) {
                historyContent.innerHTML = '<p style="text-align:center;color:#ff4444;">Please log in to view history</p>';
                return;
            }
            historyContent.innerHTML = '<p style="text-align:center;">Loading...</p>';
            // Calculate date range
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            db.collection('bodyweights')
                .where('userId', '==', user.uid)
                .orderBy('date', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        historyContent.innerHTML = '<p style="text-align:center;color:#666;">No weight records found</p>';
                        return;
                    }
                    let html = '<div style="display:grid;gap:10px;">';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!data.date || !data.weight) return;
                        const entryDate = data.date.toDate();
                        if (entryDate >= startDate) {
                            html += `<div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
                                <span>${entryDate.toLocaleDateString()} ${entryDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                                <span style="font-weight:bold;">${data.weight} kg</span>
                            </div>`;
                        }
                    });
                    html += '</div>';
                    if (html === '<div style="display:grid;gap:10px;">') {
                        html += '<p style="text-align:center;color:#666;">No records found for selected period</p>';
                    }
                    historyContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading weight history:', error);
                    historyContent.innerHTML = `<p style="text-align:center;color:#ff4444;">Error loading history: ${error.message}</p>`;
                });
        }

        function showWeightProgress() {
            document.getElementById('body-weight-modal').style.display = 'none';
            document.getElementById('weight-progress-modal').style.display = 'block';
            loadWeightProgress(30); // Default to 1 month
        }

        // Update the loadWeightProgress function to use weekly averages
function loadWeightProgress(days = 30) {
    // Update active button
    const btns = document.querySelectorAll('#weight-progress-modal .period-btn');
    btns.forEach(btn => {
        btn.classList.remove('active');
        const match = btn.getAttribute('onclick').match(/loadWeightProgress\(([^)]+)\)/);
        if (match) {
            let btnValue = match[1].replace(/'/g, '');
            let selectedValue = typeof days === 'string' ? days : days.toString();
            if (btnValue === selectedValue) btn.classList.add('active');
        }
    });
    const progressContent = document.getElementById('weight-progress-content');
    const user = firebase.auth().currentUser;
    
    if (!user) {
        progressContent.innerHTML = '<p>Please log in to view progress</p>';
        return;
    }

    progressContent.innerHTML = `
        <canvas id="weightChart" style="margin-bottom: 20px;"></canvas>
        <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0;"></div>
        <h3 style="margin-bottom: 15px;">Weekly Averages</h3>
        <div id="weeklyDetails" style="max-height: 300px; overflow-y: auto;"></div>
    `;

    db.collection('bodyweights')
        .where('userId', '==', user.uid)
        .orderBy('date', 'desc')
        .get()
        .then(snapshot => {
            if (snapshot.empty) {
                progressContent.innerHTML = '<p>No weight records found</p>';
                return;
            }

            // Group weights by week
            const weeklyWeights = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.date.toDate();
                const monday = getMonday(date);
                const weekKey = monday.toISOString().split('T')[0];

                if (!weeklyWeights[weekKey]) {
                    weeklyWeights[weekKey] = {
                        weights: [],
                        mondayDate: monday
                    };
                }
                weeklyWeights[weekKey].weights.push(data.weight);
            });

            // Calculate weekly averages and prepare chart data
            const weeks = [];
            const averages = [];
            const details = [];

            Object.entries(weeklyWeights)
                .sort(([a], [b]) => a.localeCompare(b))
                .forEach(([weekKey, data]) => {
                    const sum = data.weights.reduce((a, b) => a + b, 0);
                    const avg = sum / data.weights.length;
                    
                    weeks.push(formatDate(data.mondayDate));
                    averages.push(avg);
                    details.push({
                        week: formatDate(data.mondayDate),
                        average: avg.toFixed(1),
                        readings: data.weights.length
                    });
                });

            // Create the chart
            const ctx = document.getElementById('weightChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Weekly Average Weight (kg)',
                        data: averages,
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toFixed(1)} kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Display weekly details below the chart
            const weeklyDetails = document.getElementById('weeklyDetails');
            let html = '<div style="display: grid; gap: 10px;">';
            details.reverse().forEach((detail, index) => {
                const prevWeek = details[index + 1];
                const difference = prevWeek ? 
                    (detail.average - prevWeek.average).toFixed(1) : null;
                
                const trend = difference ? 
                    (difference > 0 ? 'üìà' : difference < 0 ? 'üìâ' : '‚û°Ô∏è') : '';
                
                const differenceText = difference ? 
                    `(${difference > 0 ? '+' : ''}${difference} kg)` : '';

                html += `
                    <div style="
                        background: rgba(255,255,255,0.1);
                        padding: 15px;
                        border-radius: 8px;
                    ">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Week of ${detail.week}</span>
                            <span style="color: #666;">${detail.readings} readings</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">${detail.average} kg</span>
                            <span style="color: ${difference > 0 ? '#ff4444' : '#4CAF50'};">
                                ${trend} ${differenceText}
                            </span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            weeklyDetails.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            progressContent.innerHTML = '<p>Error loading progress</p>';
        });
}

        // Helper function to get the Monday of the week for a given date
function getMonday(date) {
    const day = date.getDay();
    const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
    return new Date(date.setDate(diff));
}

// Helper function to format date as "MMM DD, YYYY"
function formatDate(date) {
    return date.toLocaleString('default', { month: 'short', day: 'numeric', year: 'numeric' });
}
    </script>

    <!-- Templates -->
    <div id="templates" style="display: none;">
        <template id="login-template">
            <div id="login-form">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button onclick="login()">Login</button>
                <button onclick="showRegisterForm()">Switch to Register</button>
            </div>
        </template>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2>Settings</h2>
            
            <div class="settings-section">
                <h3>Profile</h3>
                <div class="form-group">
                    <label for="change-name">Change Name</label>
                    <input type="text" id="change-name" placeholder="Enter new name">
                    <button onclick="changeName()">Update Name</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Data Management</h3>
                <button onclick="exportData()">Export Backup Data</button>
                <button onclick="importData()">Import Backup Data</button>
            </div>

            <div class="settings-section danger-zone">
                <h3>Danger Zone</h3>
                <button onclick="resetExercises()">Reset Exercise Data</button>
                <button onclick="resetWeights()">Reset Weight Data</button>
            </div>

          

            <div class="version-info">
                Version 1.0.0
            </div>

            <button onclick="closeSettings()">Close</button>
        </div>
    </div>

    <!-- Body Weight Modal -->
    <div id="body-weight-modal" class="modal">
    <div class="modal-content">
            <button class="modal-close-btn" onclick="closeBodyWeightModal()">√ó</button>
            <h2 style="margin-bottom: 20px;">Body Weight</h2>
            <div class="form-group">
                <input 
                    type="number" 
                    id="body-weight-input" 
                    placeholder="Enter weight (kg)" 
                    step="0.1" 
                    min="0"
                    style="
                        font-size: 18px;
                        text-align: center;
                        margin-bottom: 15px;
                    "
                >
                <button 
                    onclick="saveBodyWeight()"
                    style="background: linear-gradient(135deg, #ffd700, #ffb700);"
                >Save Weight</button>
                
                <div style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin-top: 20px;
                ">
                    <button 
                        onclick="showWeightHistory()"
                        style="background: linear-gradient(135deg, #2196F3, #1976D2);"
                    >History</button>
                    <button 
                        onclick="showWeightProgress()"
                        style="background: linear-gradient(135deg, #1565C0, #0D47A1);"
                    >Progress</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
<div id="weight-history-modal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="document.getElementById('weight-history-modal').style.display='none'">√ó</button>
        <h2 style="margin-bottom: 20px;">Weight History</h2>
        <div style="
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 20px;
        ">
            <button onclick="loadWeightHistory(7)" class="period-btn active">1 Week</button>
            <button onclick="loadWeightHistory(30)" class="period-btn">1 Month</button>
            <button onclick="loadWeightHistory(180)" class="period-btn">6 Months</button>
            <button onclick="loadWeightHistory(365)" class="period-btn">1 Year</button>
        </div>
        <div id="weight-history-content"></div>
    </div>
</div>

<!-- Progress Modal -->
<div id="weight-progress-modal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="document.getElementById('weight-progress-modal').style.display='none'">√ó</button>
        <h2 style="margin-bottom: 20px;">Weight Progress</h2>
        <div style="
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        ">
            <button onclick="loadWeightProgress(30)" class="period-btn active">1 Month</button>
            <button onclick="loadWeightProgress(90)" class="period-btn">3 Months</button>
            <button onclick="loadWeightProgress(180)" class="period-btn">6 Months</button>
            <button onclick="loadWeightProgress(365)" class="period-btn">1 Year</button>
        </div>
        <div id="weight-progress-content">
            <canvas id="weightChart"></canvas>
            <div id="weeklyAverages" style="margin-top: 20px;"></div>
        </div>
    </div>
</div>

<!-- Workout History Modal -->
<div id="workout-history-modal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="document.getElementById('workout-history-modal').style.display='none'">√ó</button>
        <h2 style="margin-bottom: 20px;">Workout History</h2>
        <div style="
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        ">
            <button onclick="loadWorkoutHistory(7)" class="period-btn active">1 Week</button>
            <button onclick="loadWorkoutHistory(30)" class="period-btn">1 Month</button>
            <button onclick="loadWorkoutHistory(180)" class="period-btn">6 Months</button>
            <button onclick="loadWorkoutHistory(365)" class="period-btn">1 Year</button>
        </div>
        <div id="category-filter-buttons" style="
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 20px;
        ">
        </div>
        <div id="workout-history-content" style="
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        "></div>
    </div>
</div>

<!-- Exercise Add/Edit Modal -->
<div id="exercise-modal" class="modal" onclick="if(event.target === this) closeExerciseModal()">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeExerciseModal()">√ó</button>
        <h2 id="exercise-modal-title">Add Exercise</h2>
        
        <div class="form-group">
            <label for="exercise-name-input">Exercise Name:</label>
            <input type="text" id="exercise-name-input" placeholder="Enter exercise name" style="margin-bottom: 15px;">
        </div>
        
        <div class="form-group">
            <label for="exercise-category-select">Individual Category:</label>
            <select id="exercise-category-select" style="margin-bottom: 20px;">
                <option value="">Select muscle group...</option>
            </select>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="saveExerciseFromModal()" style="background: linear-gradient(135deg, #4CAF50, #45a049) !important; flex: 1;">Save</button>
            <button onclick="closeExerciseModal()" style="background: #666; flex: 1;">Cancel</button>
        </div>
    </div>
</div>

</body>
</html>